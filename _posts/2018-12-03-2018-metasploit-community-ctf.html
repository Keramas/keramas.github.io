---
layout: post
title: 2018 Metasploit Community CTF
date: '2018-12-03T18:07:00.002-08:00'
author: Keramas
tags: 
modified_time: '2018-12-09T13:04:51.965-08:00'
thumbnail: https://1.bp.blogspot.com/-Dnl7394L_OY/XAV7SV9cEBI/AAAAAAAAAxU/l_MBmhssZxYW5_j5YBpWoIEYjbAfzvEgQCLcBGAs/s72-c/msf_ctf.png
blogger_id: tag:blogger.com,1999:blog-4206503528938574504.post-2094561849276748413
blogger_orig_url: https://k3ramas.blogspot.com/2018/12/2018-metasploit-community-ctf.html
---

The Metasploit Community CTF is a ton of fun and it is a bit different than your standard jeopardy CTF. Full details on the CTF can be found on the homepage, but to give a short breakdown of how it works:<br /><br />1. You are assigned two target boxes<br />2. Penetrate the targets and uncover specific playing card PNG images and md5sum them for the flag.<br /><br />I was a member of team "rememberingAaronSwartz", and we managed to take second place through a ton of collaboration and hard work. In traditional CTF fashion, we put together a write up of each of the challenges to share with others and also illustrate how fun this was!<br /><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Dnl7394L_OY/XAV7SV9cEBI/AAAAAAAAAxU/l_MBmhssZxYW5_j5YBpWoIEYjbAfzvEgQCLcBGAs/s1600/msf_ctf.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="252" data-original-width="1137" height="140" src="https://1.bp.blogspot.com/-Dnl7394L_OY/XAV7SV9cEBI/AAAAAAAAAxU/l_MBmhssZxYW5_j5YBpWoIEYjbAfzvEgQCLcBGAs/s640/msf_ctf.png" width="640" /></a></div><br /><br /><br /><h3>Nmap scans output from machines:</h3><br /><b>Ubuntu (172.16.4.213)</b>:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">PORT      STATE SERVICE<br />Nmap scan report for 172.16.4.213<br />Host is up, received conn-refused (0.0087s latency).<br />Scanned at 2018-12-01 02:55:28 UTC for 3555s<br />Not shown: 65525 closed ports<br />Reason: 65525 conn-refused<br />PORT      STATE SERVICE  REASON  VERSION<br />25/tcp    open  smtp     syn-ack Sendmail 5.51/5.17<br />|_smtp-commands: SMTP: EHLO 500 Command unrecognized\x0D<br />79/tcp    open  finger   syn-ack SGI IRIX or NeXTSTEP fingerd<br />|_finger: No one logged on\x0D<br />2222/tcp  open  ssh      syn-ack (protocol 2.0)<br />| fingerprint-strings:<br />|   NULL:<br />|_    SSH-2.0-libssh_0.8.3<br />---------------------------------SNIP---------------------<br />8080/tcp  open  http     syn-ack Apache Tomcat/Coyote JSP engine 1.1<br />| http-methods:<br />|_  Supported Methods: GET HEAD POST OPTIONS<br />|_http-open-proxy: Proxy might be redirecting requests<br />|_http-server-header: Apache-Coyote/1.1<br />| http-title: Struts2 Showcase<br />|_Requested resource was showcase.action<br />8181/tcp  open  http     syn-ack WEBrick httpd 1.3.1 (Ruby 2.3.0 (2015-12-25))<br />|_http-favicon: Unknown favicon MD5: EE9029912A80EA3845D439EF7E08ABF6<br />| http-methods:<br />|_  Supported Methods: GET HEAD OPTIONS<br />|_http-server-header: WEBrick/1.3.1 (Ruby/2.3.0/2015-12-25)<br />|_http-title: 8 of Diamonds<br />8443/tcp  open  ssl/http syn-ack Thin httpd<br />|_http-favicon: Unknown favicon MD5: 7E91B08265C69619AE445051AC00F125<br />|_http-server-header: thin<br />|_http-title: Site doesn't have a title (text/html;charset=utf-8).<br />| ssl-cert: Subject: commonName=93f1rywa.jpnykqxgnz.az.hakqi3.gzg9xrkmq.edu/organizationName=Joan/stateOrProvinceName=RI/countryName=US/localityName=Shirley<br />-----------------------------SNIP-----------------------<br />| 5sft8b6u6TJT5w==<br />|_-----END CERTIFICATE-----<br />|_ssl-date: TLS randomness does not represent time<br />8777/tcp  open  http     syn-ack nginx 1.15.6<br />| http-methods:<br />|_  Supported Methods: GET HEAD<br />|_http-server-header: nginx/1.15.6<br />|_http-title: Site doesn't have a title (text/html).<br />8880/tcp  open  http     syn-ack Apache httpd 2.4.7 ((Ubuntu))<br />| http-methods:<br />|_  Supported Methods: GET HEAD POST OPTIONS<br />|_http-server-header: Apache/2.4.7 (Ubuntu)<br />|_http-title: Secure File Storage<br />9021/tcp  open  http     syn-ack nginx 1.15.6<br />| http-methods:<br />|_  Supported Methods: GET HEAD<br />|_http-server-header: nginx/1.15.6<br />31063/tcp open  http     syn-ack nginx<br />| http-methods:<br />|_  Supported Methods: GET HEAD<br />|_http-server-header: nginx<br />|_http-title: 3 of Clubs<br />1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :<br />SF-Port2222-TCP:V=7.70%I=7%D=12/1%Time=5C01F829%P=x86_64-pc-linux-gnu%r(NU<br />SF:LL,16,"SSH-2\.0-libssh_0\.8\.3\r\n");<br />Service Info: Host: 2-of-diamonds; OS: Unix<br /></pre></div><br /><br /><b>Windows (172.16.4.214)</b>:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">ec2-user@kali:~$ nmap -sC -sV -p- 172.16.4.214<br />Starting Nmap 7.70 ( https://nmap.org ) at 2018-11-30 17:25 UTC<br />Nmap scan report for 172.16.4.214<br />Host is up (0.00047s latency).<br />Not shown: 65520 closed ports<br />PORT      STATE SERVICE       VERSION<br />135/tcp   open  msrpc         Microsoft Windows RPC<br />139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn<br />445/tcp   open  microsoft-ds  Microsoft Windows Server 2008 R2 - 2012 microsoft-ds<br />3389/tcp  open  ms-wbt-server Microsoft Terminal Service<br />| ssl-cert: Subject: commonName=WIN-F0RRKTD2VFF<br />| Not valid before: 2018-11-27T18:26:29<br />|_Not valid after:  2019-05-29T18:26:29<br />4444/tcp  open  ms-pe-exe     Microsoft PE executable file<br />| fingerprint-strings: <br />|   GetRequest: <br />|     !This program cannot be run in DOS mode.<br />|     DRich<br />|     .text<br />|     `.rdata<br />|     @.data<br />|_    .idata<br />5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br />|_http-server-header: Microsoft-HTTPAPI/2.0<br />|_http-title: Not Found<br />5986/tcp  open  ssl/http      Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br />|_http-server-header: Microsoft-HTTPAPI/2.0<br />|_http-title: Not Found<br />| ssl-cert: Subject: commonName=packer<br />| Subject Alternative Name: DNS:packer<br />| Not valid before: 2018-11-28T19:12:13<br />|_Not valid after:  2019-11-28T19:32:13<br />47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br />|_http-server-header: Microsoft-HTTPAPI/2.0<br />|_http-title: Not Found<br />49152/tcp open  msrpc         Microsoft Windows RPC<br />49153/tcp open  msrpc         Microsoft Windows RPC<br />49154/tcp open  msrpc         Microsoft Windows RPC<br />49155/tcp open  msrpc         Microsoft Windows RPC<br />49160/tcp open  msrpc         Microsoft Windows RPC<br />49161/tcp open  msrpc         Microsoft Windows RPC<br />49166/tcp open  msrpc         Microsoft Windows RPC<br />1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :<br />SF-Port4444-TCP:V=7.70%I=7%D=11/30%Time=5C0172C4%P=x86_64-pc-linux-gnu%r(G<br />SF:etRequest,43E0,"MZ\x90\0\x03\0\0\0\x04\0\0\0\xff\xff\0\0\xb8\0\0\0\0\0\<br />SF:0\0@\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\<br />SF:0\0\xd8\0\0\0\x0e\x1f\xba\x0e\0\xb4\t\xcd!\xb8\x01L\xcd!This\x20program<br />SF:\x20cannot\x20be\x20run\x20in\x20DOS\x20mode\.\r\r\n\$\0\0\0\0\0\0\0\x9<br />SF:cm\x99\x17\xd8\x0c\xf7D\xd8\x0c\xf7D\xd8\x0c\xf7D\xd5\^\x16D\xc6\x0c\xf<br />SF:7D\xd5\^\(D\xc8\x0c\xf7D\xd5\^\x17D\xb1\x0c\xf7D\x05\xf3<d -="" 2008="" 2012="" cpe:="" data="" e="" h="" host="" idata="" info:="" name:="" nbstat:="" netbios="" o:microsoft:windows="" oss:="" p="" r2="" r="" rdata="" results:="" script="" server="" service="" sf:0="" sf:0p="" sf:0pl="" sf:="" sf:ich="" sf:v="" sf:x04="" sf:x10="" sf:x97="" text="" unknown="" user:="" win-f0rrktd2vff="" windows="" x008="" x01="" x02="" x03="" x04="" x06="" x0b="" x0c="" x0e="" x10="" x17d="" x19="" x1a="" x20="" x7f="" x80="" x81u="" x92="" xa2="" xbc="" xbe="" xc0="" xc2="" xc8="" xc9="" xd8="" xd9="" xdcm="" xdf="" xe0="" xe2="" xf6d="" xf7d="" xf7dm="" xf7dr="">, NetBIOS MAC: 0a:1f:9f:b2:4e:42 (unknown)<br />| smb-security-mode: <br />|   account_used: guest<br />|   authentication_level: user<br />|   challenge_response: supported<br />|_  message_signing: disabled (dangerous, but default)<br />| smb2-security-mode: <br />|   2.02: <br />|_    Message signing enabled but not required<br />| smb2-time: <br />|   date: 2018-11-30 17:27:23<br />|_  start_date: 2018-11-30 17:14:40<br /><br />Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br />Nmap done: 1 IP address (1 host up) scanned in 142.00 seconds<br /></d></pre></div><br /><h3>2 of Diamonds&nbsp;</h3><div>Host: 172.16.4.213</div><div>Port: 25</div><div></div><br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">PORT   STATE SERVICE VERSION<br />25/tcp open  smtp    Sendmail 5.51/5.17<br />|_smtp-commands: SMTP: EHLO 500 Command unrecognized\x0D<br />Service Info: Host: 2-of-diamonds; OS: Unix<br /></pre></div><br /><div>Looking at the Nmap scan, it was showing Sendmail 5.51/5.17. Based on this, we found that this was a vulnerability utilized by the famous Morris Worm, and using the Metasploit module, we were able to access the machine as the "daemon" user.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/--qpeF60gpYM/XAV4ZHZkfrI/AAAAAAAAAwM/0hY-_5oBxUQlpShSVdj_xwIgd0KFUMm_ACEwYBhgL/s1600/2ofD_morris_smtp.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="750" data-original-width="1341" height="355" src="https://2.bp.blogspot.com/--qpeF60gpYM/XAV4ZHZkfrI/AAAAAAAAAwM/0hY-_5oBxUQlpShSVdj_xwIgd0KFUMm_ACEwYBhgL/s640/2ofD_morris_smtp.png" width="640" /></a></div><br /><br /><br /></div><div>This host was a 4.3BSD machine straight from 1986, which made it a bit difficult to move around and enumerate. Dumping the contents of /etc/passwd, there were a lot of users and hashes. These were extracted and most were cracked with hashcat + the rockyou wordlist.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-_wY-ftwDHJ0/XAV4YT4UdBI/AAAAAAAAAv8/MUklMU4snOgcqfyHbl4DzRDBob3qW61KACEwYBhgL/s1600/2ofD_etcpasswd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="677" data-original-width="701" height="386" src="https://2.bp.blogspot.com/-_wY-ftwDHJ0/XAV4YT4UdBI/AAAAAAAAAv8/MUklMU4snOgcqfyHbl4DzRDBob3qW61KACEwYBhgL/s400/2ofD_etcpasswd.png" width="400" /></a></div><br /><br /><br /></div><div>The user 'hunter'; however, was not cracked initially. Exploring the box we found that there were a lot of references to the Cuckoo's Egg book and started drawing on ideas from this. Using a modified word list we were able to then crack the 'hunter' user's password: msfhack.<br /><br /></div><div></div><div>Logging in with that user, we found that there was a SUID movemail binary in his folder. This allowed us to move any kind of file from one place to another as root. Experimenting with this, it was seen that it also changes the permissions of the resulting file.&nbsp;</div><div></div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-KrRlVv0NJdk/XAV4YgQS0-I/AAAAAAAAAws/l0jY0-NvKZ4b2rcNc6gWk4A0t7L3VclVQCEwYBhgL/s1600/2ofD_foundMovemail.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="379" data-original-width="558" height="271" src="https://1.bp.blogspot.com/-KrRlVv0NJdk/XAV4YgQS0-I/AAAAAAAAAws/l0jY0-NvKZ4b2rcNc6gWk4A0t7L3VclVQCEwYBhgL/s400/2ofD_foundMovemail.png" width="400" /></a></div><br /><br />Looking around the box some more and correlating interesting things seen from the /etc/passwd file, we noticed that in the games directory, there was a very new file compared to the rest.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-ucZPG6TlDZ0/XAV4YVrVx4I/AAAAAAAAAws/JAACtH1-0HMjM0Us4RQq-MyAFdgvUOCKwCEwYBhgL/s1600/2ofD_foundAdventure.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="153" data-original-width="532" height="115" src="https://2.bp.blogspot.com/-ucZPG6TlDZ0/XAV4YVrVx4I/AAAAAAAAAws/JAACtH1-0HMjM0Us4RQq-MyAFdgvUOCKwCEwYBhgL/s400/2ofD_foundAdventure.png" width="400" /></a></div><br /><br /><br />Exploring more in this directory, the lib folder contained the interesting 2_of_diamonds.dat. However, we could not do much with it due to permissions. However, using movemail allowed us to move this into the hunter folder and it changed the permissions in the process allowing us to read the file. This turned out to be an encrypted file which needed a password.<br /><br /></div><div></div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-mcqhMD7mKSc/XAV4Y6eQvGI/AAAAAAAAAwo/ghWeJNVNYdENas_ZwnwKFueE0BpJMjHwwCEwYBhgL/s1600/2ofD_founddat.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="93" data-original-width="614" height="60" src="https://4.bp.blogspot.com/-mcqhMD7mKSc/XAV4Y6eQvGI/AAAAAAAAAwo/ghWeJNVNYdENas_ZwnwKFueE0BpJMjHwwCEwYBhgL/s400/2ofD_founddat.png" width="400" /></a></div><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-0_N4b2cgLHQ/XAV4Zp8J7NI/AAAAAAAAAw4/9syp0a0EGBkMp1ujYGhHzrNawJj90UWVwCEwYBhgL/s1600/2ofD_movemailusage.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="160" data-original-width="767" height="82" src="https://2.bp.blogspot.com/-0_N4b2cgLHQ/XAV4Zp8J7NI/AAAAAAAAAw4/9syp0a0EGBkMp1ujYGhHzrNawJj90UWVwCEwYBhgL/s400/2ofD_movemailusage.png" width="400" /></a></div><br /><br />Going back to adventure, it turned out that this was a modified version of the game that you had to play to advanced in the 2 of Diamonds challenge. Playing the game with a guide, there is a flag which if you later drop along with the rest of your loot will give you the password to the .dat file: wyvern.&nbsp;</div><div></div><div></div><div>Unfortunately, the box was lacking most of the common means to transfer this .dat file over, so the 'od' command was used to copy and paste the data to the attack machine. We then used the 'crypt' command to decrypt the 2_of_diamonds.png.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-MlxoN-uXlTM/XAV4YB6hZoI/AAAAAAAAAw4/KQjSoAVLPf0fVx6IfXdrDQ2E6nFI058ZgCEwYBhgL/s1600/2_of_diamonds.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="700" data-original-width="500" height="320" src="https://4.bp.blogspot.com/-MlxoN-uXlTM/XAV4YB6hZoI/AAAAAAAAAw4/KQjSoAVLPf0fVx6IfXdrDQ2E6nFI058ZgCEwYBhgL/s320/2_of_diamonds.png" width="228" /></a></div><br /><br /></div><div></div><div></div><div></div><div></div><h3>3 of Diamonds</h3><div>Host: 172.16.4.213</div><div>Port: 8777</div><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">PORT     STATE SERVICE VERSION<br />8777/tcp open  http    nginx 1.15.6<br />|_http-server-header: nginx/1.15.6<br />|_http-title: Site doesn't have a title (text/html).<br /></pre></div><div></div><div><br />Checking out port 8777 via a browser, we are greeted with a secure file storage service.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-hVOM1J68yOI/XAV4azJm_QI/AAAAAAAAAw8/rYvehUlozUcNPrzJHo9ZdZMXjp4A2IuvgCEwYBhgL/s1600/3ofD_securefilestorage.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="537" data-original-width="1600" height="212" src="https://4.bp.blogspot.com/-hVOM1J68yOI/XAV4azJm_QI/AAAAAAAAAw8/rYvehUlozUcNPrzJHo9ZdZMXjp4A2IuvgCEwYBhgL/s640/3ofD_securefilestorage.png" width="640" /></a></div><br /><br />There was a section to download file, but we needed to provide a valid key.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-q__HC23L6F0/XAV4abvywkI/AAAAAAAAAw0/Mae9KZ2Q3yAhlev4gntKy8CEmcnnousUwCEwYBhgL/s1600/3ofD_secure_key.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="217" data-original-width="606" height="142" src="https://1.bp.blogspot.com/-q__HC23L6F0/XAV4abvywkI/AAAAAAAAAw0/Mae9KZ2Q3yAhlev4gntKy8CEmcnnousUwCEwYBhgL/s400/3ofD_secure_key.png" width="400" /></a></div><br /><br />Using Burp Suite, the request sending a fake key was captured, and it was determined that this was susceptible to SQL injection through manual testing.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-vSpNZMdVNjg/XAV4a7pif0I/AAAAAAAAAxA/JwJbCBHMU-AKGUp0iZIuFys-JXb27sUjwCEwYBhgL/s1600/3ofD_sqli_vuln.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="208" data-original-width="1375" height="96" src="https://1.bp.blogspot.com/-vSpNZMdVNjg/XAV4a7pif0I/AAAAAAAAAxA/JwJbCBHMU-AKGUp0iZIuFys-JXb27sUjwCEwYBhgL/s640/3ofD_sqli_vuln.png" width="640" /></a></div><br /><br /><br /></div><div></div><div><burp></burp></div><div></div><div></div><div>Saving this request to a file, sqlmap was then used to dump the database, which contained the ace_of_hearts.key (which will be used for a different challenge) and the base64 of the 3 of Diamonds.png:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-4JwnAadPNEk/XAV4aONzakI/AAAAAAAAAw4/V5DZgMXf-Ck12oL06C9G9ief1EGdC3dqwCEwYBhgL/s1600/3_of_diamonds.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="720" data-original-width="544" height="320" src="https://1.bp.blogspot.com/-4JwnAadPNEk/XAV4aONzakI/AAAAAAAAAw4/V5DZgMXf-Ck12oL06C9G9ief1EGdC3dqwCEwYBhgL/s320/3_of_diamonds.png" width="241" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><br /><br /><h3>Windows Foothold</h3><div><div>Host: 172.16.4.214</div><div>Port: 4444</div></div><div><br /></div><div>Probing port 4444 of the windows machine with netcat resulted in a bunch of binary being dumped out. Curling this and saving it into a file, it was possible to boot this up in a Windows VM and attach it to Immunity debugger and then fuzz the running service over port 4444, which resulted in a buffer overflow.&nbsp;</div><div><br /></div><div>EIP was overwritten with an offset of 1017 bytes.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-C4Jq7YEb4o0/XAz7jLHfE_I/AAAAAAAAAyA/56N2Oe2wcygnZFKFXH4qFLioeldqNd-hQCEwYBhgL/s1600/registers.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="147" data-original-width="282" src="https://3.bp.blogspot.com/-C4Jq7YEb4o0/XAz7jLHfE_I/AAAAAAAAAyA/56N2Oe2wcygnZFKFXH4qFLioeldqNd-hQCEwYBhgL/s1600/registers.png" /></a></div><div><br /></div><div><br /></div><div>Looking at the stack after the crash, if we could find an instruction set with 5 pops + a ret, we could land right to the start of the buffer.&nbsp;</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-Cda6WmtMCow/XAz7jBq_UvI/AAAAAAAAAyA/s992wFu9qdYUnbbXxvvSKqpusd_aOF46gCEwYBhgL/s1600/stackshot.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="234" data-original-width="354" height="211" src="https://3.bp.blogspot.com/-Cda6WmtMCow/XAz7jBq_UvI/AAAAAAAAAyA/s992wFu9qdYUnbbXxvvSKqpusd_aOF46gCEwYBhgL/s320/stackshot.png" width="320" /></a></div><div><br /></div><div><br /></div><div>We managed to find just what we needed at 0x1047DCAC.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-qUgpdzESB48/XAz7jBWWIOI/AAAAAAAAAyA/4NppPL3FKjQA6-Xslhzxy6CpQ4_hocoMQCEwYBhgL/s1600/fivepops.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="94" data-original-width="378" height="79" src="https://4.bp.blogspot.com/-qUgpdzESB48/XAz7jBWWIOI/AAAAAAAAAyA/4NppPL3FKjQA6-Xslhzxy6CpQ4_hocoMQCEwYBhgL/s320/fivepops.png" width="320" /></a></div><div><br /></div><div><br /></div><div>After confirming this worked, we added reverse shell shellcode to the start of our buffer and got a foothold on the box. We then set up an admin account so we could RDP into the box, and there was a treasure trove of challenges waiting to be solved.&nbsp;</div><div><br /></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-y-rKbYV7VAA/XAz7jpMJTkI/AAAAAAAAAx8/2uqoieFuIo0_3MmUhFEq8q8we1MYdtfEACEwYBhgL/s1600/windows_rdp_session.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="633" data-original-width="804" height="502" src="https://1.bp.blogspot.com/-y-rKbYV7VAA/XAz7jpMJTkI/AAAAAAAAAx8/2uqoieFuIo0_3MmUhFEq8q8we1MYdtfEACEwYBhgL/s640/windows_rdp_session.png" width="640" /></a></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><h3>Ace of Diamonds</h3><div>Host: 172.16.4.214</div><div></div><div><br /></div><div>Searching the Windows box beyond what was present in the administrator's desktop folder, we came across a strange executable, 'flag_finder_9000.exe" and an obfuscated PNG image.&nbsp;</div><div><br /></div><div>Copying both over to a VM, running the executable prompted for two arguments: filename and a magic number.&nbsp;</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-oUB88uDJ0pM/XAz-vrAEQyI/AAAAAAAAAyc/9nti_cJtPD4gHFUGC5__hXyhmLyQcYYPACEwYBhgL/s1600/AoD-start.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="78" data-original-width="628" height="78" src="https://2.bp.blogspot.com/-oUB88uDJ0pM/XAz-vrAEQyI/AAAAAAAAAyc/9nti_cJtPD4gHFUGC5__hXyhmLyQcYYPACEwYBhgL/s640/AoD-start.png" width="640" /></a></div><div><br /></div><div><br /></div><div>Loading the executable up in IDA, it was easy to find the check that was occurring:</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-WNDnZ0Rnk0k/XAz-viflzEI/AAAAAAAAAyU/dgxDDCsxvm0f6m-cB2sf0q9RT1SOuTwXACEwYBhgL/s1600/AoD1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="698" data-original-width="974" height="458" src="https://4.bp.blogspot.com/-WNDnZ0Rnk0k/XAz-viflzEI/AAAAAAAAAyU/dgxDDCsxvm0f6m-cB2sf0q9RT1SOuTwXACEwYBhgL/s640/AoD1.png" width="640" /></a></div><div><br /></div><div><br /></div><div><br /></div><div>Letting IDA do the heavy lifting, it revealed the magic number to be Jenny's number...</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-pSTH1pzjtjY/XAz-vkS-ZHI/AAAAAAAAAyY/r_Uld-gleFQJUxhuzD14VZBeajn3v4B_gCEwYBhgL/s1600/AoD2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="75" data-original-width="194" src="https://4.bp.blogspot.com/-pSTH1pzjtjY/XAz-vkS-ZHI/AAAAAAAAAyY/r_Uld-gleFQJUxhuzD14VZBeajn3v4B_gCEwYBhgL/s1600/AoD2.png" /></a></div><div><br /></div><div><br /></div><div><br /></div><div>Running the executable again feeding it the obfuscated PNG file as the filename and the uncovered magic number, it spits out the Ace of Diamonds flag.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-pBty1mtTh7Y/XAz_URqwDUI/AAAAAAAAAys/sGxAWH-XMR8IR_FPZrygidlNSN5W4P3_ACLcBGAs/s1600/success.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="700" data-original-width="500" height="320" src="https://3.bp.blogspot.com/-pBty1mtTh7Y/XAz_URqwDUI/AAAAAAAAAys/sGxAWH-XMR8IR_FPZrygidlNSN5W4P3_ACLcBGAs/s320/success.png" width="228" /></a></div><div><br /></div><br /><br /><br />The rest of the challenge writeups (including the above) can be found on my teammate MinatoTW's Secjuice blog:<br /><a href="https://www.secjuice.com/metasploit-ctf/">https://www.secjuice.com/metasploit-ctf/</a><br /><br />Looking forward to next year!</div>