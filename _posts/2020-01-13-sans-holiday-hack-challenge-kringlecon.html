---
layout: post
title: 'SANS Holiday Hack Challenge: KringleCon 2019'
date: '2020-01-13T11:54:00.000-08:00'
author: Keramas
tags: 
modified_time: '2020-01-13T12:55:40.883-08:00'
thumbnail: https://1.bp.blogspot.com/-jyuxGSDIJ0Q/XhzZPX-sbcI/AAAAAAAABMU/L76AvwKQE7o3n03yrd8TImI1ReU9JQCnQCLcBGAsYHQ/s72-c/kringlecon_keramas.png
blogger_id: tag:blogger.com,1999:blog-4206503528938574504.post-4046721034080347877
blogger_orig_url: https://k3ramas.blogspot.com/2020/01/sans-holiday-hack-challenge-kringlecon.html
---

This was the first year I participated in Kringlecon, and I was really impressed with how well made it was. With a variety of challenges exploring different aspects of information security, both in the realm of penetration testing and blue team techniques, and a range of difficulties, it made for a CTF event that was accessible to all. Paired with really great resources and materials for each challenge, the whole event was excellent.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-jyuxGSDIJ0Q/XhzZPX-sbcI/AAAAAAAABMU/L76AvwKQE7o3n03yrd8TImI1ReU9JQCnQCLcBGAsYHQ/s1600/kringlecon_keramas.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="219" data-original-width="236" height="370" src="https://1.bp.blogspot.com/-jyuxGSDIJ0Q/XhzZPX-sbcI/AAAAAAAABMU/L76AvwKQE7o3n03yrd8TImI1ReU9JQCnQCLcBGAsYHQ/s400/kringlecon_keramas.png" width="400" /></a></div><br /><br />Originally due to the bustle of the holidays and closing out the year, I didn't plan on participating, but a friend asked for some help on one of the challenges, and after that I couldn't stop--I was hooked and had to keep solving.<br /><br />While this blog entry doesn't contain a full write-up of all the great challenges, this is only a few of the more complicated ones which I enjoyed the most.<br /><br /><h3>Objective 8 - Machines can also learn to be an Elf - Machine Learning to Bypass a CAPTCHA</h3><div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-N4or3WnREgM/XgbC7rnLBFI/AAAAAAAABIo/yl3uFFt99CwfRtPo_iCxGf3Kb-Erlk4nACEwYBhgL/s1600/ML_objective_info.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="218" data-original-width="554" height="250" src="https://1.bp.blogspot.com/-N4or3WnREgM/XgbC7rnLBFI/AAAAAAAABIo/yl3uFFt99CwfRtPo_iCxGf3Kb-Erlk4nACEwYBhgL/s640/ML_objective_info.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />I loved this challenge as it taught me something genuinely new as my knowledge about machine learning was extremely limited.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-gjupZCespVQ/XgbC-RQfTKI/AAAAAAAABIY/-JBlhpvmUN0_2b1OWHp1CY_P2aht_kwLQCEwYBhgL/s1600/frido_home.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" data-original-height="787" data-original-width="771" height="640" src="https://1.bp.blogspot.com/-gjupZCespVQ/XgbC-RQfTKI/AAAAAAAABIY/-JBlhpvmUN0_2b1OWHp1CY_P2aht_kwLQCEwYBhgL/s640/frido_home.png" width="626" /></a></div></div><div><br /></div><div>We need to submit our entry for the chance to win some free cookies, but we are presented with a CAPTCHA that asks to identify three different kind of items in a time frame of 5 seconds, which, is not humanly possible.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-azSwsD8hZsc/XgbC7_Ca8yI/AAAAAAAABIk/vM-GmbXhSS4U36gS8FJN44loXAzKtf2AACEwYBhgL/s1600/captcha.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="813" data-original-width="740" height="640" src="https://1.bp.blogspot.com/-azSwsD8hZsc/XgbC7_Ca8yI/AAAAAAAABIk/vM-GmbXhSS4U36gS8FJN44loXAzKtf2AACEwYBhgL/s640/captcha.png" width="582" /></a></div><br /><br />Enter machine learning and TensorFlow! The following resources were provided to give a bit of knowledge on this topic:&nbsp;</div><div><br /></div><div><a href="https://www.youtube.com/watch?v=jmVPLwjm_zs&amp;feature=youtu.be">https://www.youtube.com/watch?v=jmVPLwjm_zs&amp;feature=youtu.be</a></div><div><a href="https://github.com/chrisjd20/img_rec_tf_ml_demo">https://github.com/chrisjd20/img_rec_tf_ml_demo</a></div><div><br /></div><div>Additionally, the challenge gives us an archive of 12,000 images, separated into categories of the different types of images, as well as a Python-based script to get us started. All the tools and necessary things are provided, it's just up to us to perform the machine training and code up the logic to handle everything to bypass the actual CAPTCHA.<br /><br />First, we need to use the "retrain.py" script included in the Github repo to train the machine to recognize each of the different categories of images. To do this, we just point the script to the directory that contains all 12,000 images and let it run. Output will look similar to the following:<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Y5sKqGMdGdA/Xgrz_Vdo03I/AAAAAAAABKY/uZfSPuekw9IuQoPJYAdRBR-vBCTOb4JUgCLcBGAsYHQ/s1600/retrain1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="589" data-original-width="1002" height="376" src="https://1.bp.blogspot.com/-Y5sKqGMdGdA/Xgrz_Vdo03I/AAAAAAAABKY/uZfSPuekw9IuQoPJYAdRBR-vBCTOb4JUgCLcBGAsYHQ/s640/retrain1.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-_BWnX_Ie6j4/Xgrz_jjUZiI/AAAAAAAABKg/XD7iKyMsCCYE3x8MhVn-6L9TNgI7LUoFwCLcBGAsYHQ/s1600/retrain2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="311" data-original-width="799" height="248" src="https://1.bp.blogspot.com/-_BWnX_Ie6j4/Xgrz_jjUZiI/AAAAAAAABKg/XD7iKyMsCCYE3x8MhVn-6L9TNgI7LUoFwCLcBGAsYHQ/s640/retrain2.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-w20lNp0MOg0/Xgrz_Sr0vDI/AAAAAAAABKc/JI82rnZu4f0GjA9JG5mqCNVoK3aH1rBOACLcBGAsYHQ/s1600/retrain3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="377" data-original-width="1170" height="206" src="https://1.bp.blogspot.com/-w20lNp0MOg0/Xgrz_Sr0vDI/AAAAAAAABKc/JI82rnZu4f0GjA9JG5mqCNVoK3aH1rBOACLcBGAsYHQ/s640/retrain3.png" width="640" /></a></div><br />Next, I modified some of the code in the repo so I could just import it as a library, and then added and modified code in the half-completed script that was provided, which will quickly save all the CAPTCHA images generated to a directory, and then calls the library to analyze and predict what each image should be.<br /><br />Poketrainer.py<br /><script src="https://gist.github.com/Keramas/7515964d1bcf8267591b69821a0d0765.js"></script><br /><br />capteha_api.py<br /><script src="https://gist.github.com/Keramas/1c6d42b46bf35f306fe085b6ec3a2b00.js"></script><br /><br />All of the UUIDs of the predicted images are stored in a list and then submitted as a POST request for the CAPTCHA solution. Naturally, I could have likely made major improvements to this script to enhance the speed I suppose, but this ended up working nicely.&nbsp;</div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-7CO5UagmYvE/XhEyfpbVYrI/AAAAAAAABLk/YRe9xU2420kLy4MAoU2cmnAvP_RHa_qSgCLcBGAsYHQ/s1600/machine_processing_unknowns.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="219" data-original-width="656" height="211" src="https://1.bp.blogspot.com/-7CO5UagmYvE/XhEyfpbVYrI/AAAAAAAABLk/YRe9xU2420kLy4MAoU2cmnAvP_RHa_qSgCLcBGAsYHQ/s640/machine_processing_unknowns.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-JAVQc99mB1w/XhEzPYejK8I/AAAAAAAABLs/-RPJFC5IntI9gRjIWf_MSzGvpfim0PlNwCLcBGAsYHQ/s1600/machine_learning_success.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="280" data-original-width="966" height="184" src="https://1.bp.blogspot.com/-JAVQc99mB1w/XhEzPYejK8I/AAAAAAAABLs/-RPJFC5IntI9gRjIWf_MSzGvpfim0PlNwCLcBGAsYHQ/s640/machine_learning_success.png" width="640" /></a></div><br />An email is sent to the address you add to the script which gives the flag:</div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-klwtfPT3iLA/XgbDAL93MuI/AAAAAAAABIc/Mghjmwq1lJwno8eo9bFAKBWOu1ATmbroACEwYBhgL/s1600/machinelearn_flag.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="313" data-original-width="539" height="370" src="https://1.bp.blogspot.com/-klwtfPT3iLA/XgbDAL93MuI/AAAAAAAABIc/Mghjmwq1lJwno8eo9bFAKBWOu1ATmbroACEwYBhgL/s640/machinelearn_flag.png" width="640" /></a></div><br /></div><h3>Objective 9 - Sleighing the DB Blind&nbsp; - SQL Injection to Retrieve the Datas</h3><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-y0NnPRpI2bA/XgbDBcMpyQI/AAAAAAAABIg/MiLPN1cJfNAe2faa1fRCierL3mFn2CMeQCEwYBhgL/s1600/sqli_injection_info.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="235" data-original-width="553" height="270" src="https://1.bp.blogspot.com/-y0NnPRpI2bA/XgbDBcMpyQI/AAAAAAAABIg/MiLPN1cJfNAe2faa1fRCierL3mFn2CMeQCEwYBhgL/s640/sqli_injection_info.png" width="640" /></a></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div>Based on the objective text, it's quite obvious SQL injection is going to be the key here. We're presented with a web page that contains a form to submit university applications.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-cyZRDOWCBFE/XgbDCOO8vSI/AAAAAAAABIk/vp7kYP15YIExNMQsuQDoUpB-QvEIJ7CGwCEwYBhgL/s1600/student_portal_home.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="622" data-original-width="978" height="406" src="https://1.bp.blogspot.com/-cyZRDOWCBFE/XgbDCOO8vSI/AAAAAAAABIk/vp7kYP15YIExNMQsuQDoUpB-QvEIJ7CGwCEwYBhgL/s640/student_portal_home.png" width="640" /></a></div><br /><br />However, looking at the requests that take place, before every request is made to the backend, the "validator.php" file is called and a unique time-based token is generated which must be used immediately. Due to this, we need to ensure that this is generated and placed into our SQL injection payload so the request is processed.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Lw9ssyYx9YU/XgbDC2FZ1nI/AAAAAAAABIo/GmxdfQfOGasBcLnxlv2Hlg1mUtM2ep_uwCEwYBhgL/s1600/valiator_request.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="359" data-original-width="1312" height="174" src="https://1.bp.blogspot.com/-Lw9ssyYx9YU/XgbDC2FZ1nI/AAAAAAAABIo/GmxdfQfOGasBcLnxlv2Hlg1mUtM2ep_uwCEwYBhgL/s640/valiator_request.png" width="640" /></a></div><br /><br /><br />There are two ways to do this: using a custom sqlmap tamper script or by using Burp Suite macros. I decided to just let Burp handle everything, but in either case, we are going to let sqlmap do all the heavy lifting after all is said and done.<br /><br />First, I confirmed that SQL injection was possible by sending some apostrophes in the form data.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-4qVWh8IEdcg/XgbC7tLd1ZI/AAAAAAAABIc/s4xH_rNx4HsfPEt4lfXqiUy--wrlLFV5gCEwYBhgL/s1600/application_form.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="450" data-original-width="496" height="580" src="https://1.bp.blogspot.com/-4qVWh8IEdcg/XgbC7tLd1ZI/AAAAAAAABIc/s4xH_rNx4HsfPEt4lfXqiUy--wrlLFV5gCEwYBhgL/s640/application_form.png" width="640" /></a></div><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-pdYNIpdS90g/XgbC-h-aunI/AAAAAAAABIk/9wttBEjVKDs2kaho_hPZnzIzSMp7QKVywCEwYBhgL/s1600/injection_error.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="179" data-original-width="974" height="116" src="https://1.bp.blogspot.com/-pdYNIpdS90g/XgbC-h-aunI/AAAAAAAABIk/9wttBEjVKDs2kaho_hPZnzIzSMp7QKVywCEwYBhgL/s640/injection_error.png" width="640" /></a></div><br />This error shows us that input placed into the name field is not sanitized and used as-is, which means we can insert arbitrary SQL queries. Now we just need to set up a Burp macro and session handling rule so we can process this through sqlmap. This is accomplished via the following steps:<br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div>Project options &gt; Sessions tab&nbsp; &gt; Macros &gt; Add<br /><br /><div class="separator" style="clear: both; text-align: center;"></div>From within the Macro Editor, the request to validator.php can be selected from the proxy history.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-nUGDlBnCcCc/XgrwZJNyEhI/AAAAAAAABJ8/PAgWE8exv_kJ-oHqWlAup0rNOlYBfjJUACLcBGAsYHQ/s1600/token_macro.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="783" data-original-width="1185" height="422" src="https://1.bp.blogspot.com/-nUGDlBnCcCc/XgrwZJNyEhI/AAAAAAAABJ8/PAgWE8exv_kJ-oHqWlAup0rNOlYBfjJUACLcBGAsYHQ/s640/token_macro.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div>The Configure Item option can then be selected, and a custom parameter can be defined.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-TtATcs4LmYU/Xgrr-kvm_iI/AAAAAAAABJs/wGEiDxNx09cpUUq6uQeoy6ewbs2qGF1uQCEwYBhgL/s1600/custom_parameter_settings.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="967" data-original-width="1149" height="538" src="https://1.bp.blogspot.com/-TtATcs4LmYU/Xgrr-kvm_iI/AAAAAAAABJs/wGEiDxNx09cpUUq6uQeoy6ewbs2qGF1uQCEwYBhgL/s640/custom_parameter_settings.png" width="640" /></a></div><br />Back in the Sessions tab under Session Handling Rules, a new rule can be added, and the rule can be set to run the macro that was just created.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-SZBPFcbK97A/XgrzRQl3joI/AAAAAAAABKQ/sT0d6Ty1ZhgKq6Z_qBM3gPQZwHndVOxhACLcBGAsYHQ/s1600/elfu_token_macro.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="432" data-original-width="809" height="340" src="https://1.bp.blogspot.com/-SZBPFcbK97A/XgrzRQl3joI/AAAAAAAABKQ/sT0d6Ty1ZhgKq6Z_qBM3gPQZwHndVOxhACLcBGAsYHQ/s640/elfu_token_macro.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The options when selecting the macro should look like the following:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-cSdgkxSuDQ0/XgrsDkagmhI/AAAAAAAABJs/luPfZ1l0R2kBpcZn5U94mx0VzDitC6RbQCEwYBhgL/s1600/token_session_screen.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="770" data-original-width="1008" height="488" src="https://1.bp.blogspot.com/-cSdgkxSuDQ0/XgrsDkagmhI/AAAAAAAABJs/luPfZ1l0R2kBpcZn5U94mx0VzDitC6RbQCEwYBhgL/s640/token_session_screen.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The scope of this rule can then be modified to include the proxy.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-TmY-N-tE0MY/Xgrr8NfbL4I/AAAAAAAABJg/OPRRwz9JhMIQIHGEKKaUmSbrA_J9sdTWACEwYBhgL/s1600/session_scope.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="195" data-original-width="588" height="131" src="https://1.bp.blogspot.com/-TmY-N-tE0MY/Xgrr8NfbL4I/AAAAAAAABJg/OPRRwz9JhMIQIHGEKKaUmSbrA_J9sdTWACEwYBhgL/s400/session_scope.png" width="400" /></a></div><br /><br />Now all that needs to be done is to point sqlmap to the Burp proxy, and the token generation will be handled automagically allowing for our sqlmap payloads to get through.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-93lDXqGy5Ug/Xgrr4ZLCDMI/AAAAAAAABJs/4JCP36bdQSUrfW4LiRp_8RmbG6YcOuEkQCEwYBhgL/s1600/sqlmap_1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="593" data-original-width="1425" src="https://1.bp.blogspot.com/-93lDXqGy5Ug/Xgrr4ZLCDMI/AAAAAAAABJs/4JCP36bdQSUrfW4LiRp_8RmbG6YcOuEkQCEwYBhgL/s1600/sqlmap_1.png" /></a></div><br /><br />Allowing this to run, we can dump the entire database and we discover the "krampus" table which contained various "path" values indicating PNG images.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-jGxiZEDeBzs/Xgrr4a1Sq0I/AAAAAAAABJc/mz-3l6qzzLEorXE5tk2qIYVO6v2D4iGZQCEwYBhgL/s1600/sqlmap_results.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="239" data-original-width="361" height="263" src="https://1.bp.blogspot.com/-jGxiZEDeBzs/Xgrr4a1Sq0I/AAAAAAAABJc/mz-3l6qzzLEorXE5tk2qIYVO6v2D4iGZQCEwYBhgL/s400/sqlmap_results.png" width="400" /></a></div><br /><br /><br />Browsing to these PNGs gives the answer to the objective: Super Sled-o-matic<br /><span style="text-align: center;"><br /></span><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-PcKm3VXxDfo/XgrsQxthQXI/AAAAAAAABJo/NiQnzTFnkLIPpn02dw7Di7yO0yD4-45NQCEwYBhgL/s1600/sql_answer_objective9.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="154" data-original-width="281" height="219" src="https://1.bp.blogspot.com/-PcKm3VXxDfo/XgrsQxthQXI/AAAAAAAABJo/NiQnzTFnkLIPpn02dw7Di7yO0yD4-45NQCEwYBhgL/s400/sql_answer_objective9.png" width="400" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div><span style="text-align: center;"><br /></span><br /><span style="text-align: center;"><br /></span><span style="text-align: center;"><br /></span><span style="text-align: center;"><br /></span><br /><h3>Objective 10 - Elfscrow Inside and Out: Reversing and Crypto</h3><br /></div><div><image></image></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-tUHMmf3-ZsY/XgbC8MxKIHI/AAAAAAAABIY/s_Cw3AwQNcs8jiyHMCzNIK5r4mRwRiMCwCEwYBhgL/s1600/crypto_objective_info.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="367" data-original-width="550" height="426" src="https://1.bp.blogspot.com/-tUHMmf3-ZsY/XgbC8MxKIHI/AAAAAAAABIY/s_Cw3AwQNcs8jiyHMCzNIK5r4mRwRiMCwCEwYBhgL/s640/crypto_objective_info.png" width="640" /></a></div><br /><br />The objective provides a Windows binary, a PDB file, and an encrypted PDF file. The goal is to analyze the binary and determine how to break the cryptography. The following resource was given, and it was very well made to learn more on this topic:</div><div><br /></div><div><a href="https://www.youtube.com/watch?v=obJdpKDpFBA&amp;feature=youtu.be">https://www.youtube.com/watch?v=obJdpKDpFBA&amp;feature=youtu.be</a></div><div><br /></div><div>To start off, I explored the executable by running it to determine its use.</div><div><br /></div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-lZD3Yb1Inx8/XgbC9b4B_AI/AAAAAAAABIY/ZcANMJ-usYoL2xGW4YidhK_a5DradmhiQCEwYBhgL/s1600/elfscrow_ran.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="282" data-original-width="648" height="278" src="https://1.bp.blogspot.com/-lZD3Yb1Inx8/XgbC9b4B_AI/AAAAAAAABIY/ZcANMJ-usYoL2xGW4YidhK_a5DradmhiQCEwYBhgL/s640/elfscrow_ran.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><br /></div></div><div>There is an insecure mode with some text hinting at insecurities, and it appears we need an ID in order to perform the decryption. As a test, I tried to encrypt a file.</div><div><br /></div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-LwP1jl3Tki8/XgbC96J0Y8I/AAAAAAAABIs/XXFmpUGnw0INDKfOd0zMopoPItQ_gOqdgCEwYBhgL/s1600/encryption_output.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="464" data-original-width="731" height="406" src="https://1.bp.blogspot.com/-LwP1jl3Tki8/XgbC96J0Y8I/AAAAAAAABIs/XXFmpUGnw0INDKfOd0zMopoPItQ_gOqdgCEwYBhgL/s640/encryption_output.png" width="640" /></a></div><br />The output gives a seed value, a key, and an ID. After this, I loaded the binary and the PDB into IDA to explore what is happening. From the main function we have paths to both the encrypt and decrypt functions, and exploring the "do_decrypt" function we can see that it starts by performing an internet connection check, and reaches out to the server to try and grab it. We'll come back to this, but the more important aspect is how this file is getting encrypted.</div><div><br /></div><div><br /></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-ETvb3gnDiYg/XgbC9OP69yI/AAAAAAAABIs/PWl3OunKyuQDRpo1kAWihVKVaMukyJRqACEwYBhgL/s1600/decrypt_entrypoint.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="815" data-original-width="940" height="554" src="https://1.bp.blogspot.com/-ETvb3gnDiYg/XgbC9OP69yI/AAAAAAAABIs/PWl3OunKyuQDRpo1kAWihVKVaMukyJRqACEwYBhgL/s640/decrypt_entrypoint.png" width="640" /></a></div><br />Following the "do_encrypt" function, we can see that the seed is being generated based on the time function, which is going to grab an epoch time value based on our system time.&nbsp;</div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-QMauybDvc6A/XgbC-Yb-iYI/AAAAAAAABIU/JQkT5IWLlEsVXbEbE4mrqD2oTjLa3UBFQCEwYBhgL/s1600/generate_key.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="827" data-original-width="697" height="640" src="https://1.bp.blogspot.com/-QMauybDvc6A/XgbC-Yb-iYI/AAAAAAAABIU/JQkT5IWLlEsVXbEbE4mrqD2oTjLa3UBFQCEwYBhgL/s640/generate_key.png" width="538" /></a></div><br />Following this further to the super_secure_random, this shows us exactly how the key value is being generated. It is taking the state, which is our seed (epoch time value), multiplies it by 214013, adds 2531011, performs a bitwise shift, and then performs a bitwise AND operation. Using this, we can generate our own key if we know the seed.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Z04o1Iw62Ug/XgbDAlKTeuI/AAAAAAAABIg/OiFx3Uz81TYxOoamse1kk5JFivi0wTgxwCEwYBhgL/s1600/secure_random.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="323" data-original-width="271" height="640" src="https://1.bp.blogspot.com/-Z04o1Iw62Ug/XgbDAlKTeuI/AAAAAAAABIg/OiFx3Uz81TYxOoamse1kk5JFivi0wTgxwCEwYBhgL/s640/secure_random.png" width="536" /></a></div><br />Looking at other functions present, we can also see two different API calls being made. When encrypting, a call to "/api/store" is made, which will store the encryption key on the remote server.</div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/--WPHBLheH34/XgbDBqMhXcI/AAAAAAAABIg/XhgYkKTU4RoN88T6JOXLNd4d3UuX4ZtGgCEwYBhgL/s1600/store_key.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="339" data-original-width="547" height="396" src="https://1.bp.blogspot.com/--WPHBLheH34/XgbDBqMhXcI/AAAAAAAABIg/XhgYkKTU4RoN88T6JOXLNd4d3UuX4ZtGgCEwYBhgL/s640/store_key.png" width="640" /></a></div><br />Additionally, when decrypting, a call to "/api/retrieve" will be made, which uses the ID value in order to retrieve a stored encryption key from the server.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-PI82--iHuKc/XgbC7sZjgmI/AAAAAAAABIk/_ctDg32ZDQAP06okvbwVNY-k7M9P2mguwCEwYBhgL/s1600/api_retrieve.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="606" data-original-width="920" height="420" src="https://1.bp.blogspot.com/-PI82--iHuKc/XgbC7sZjgmI/AAAAAAAABIk/_ctDg32ZDQAP06okvbwVNY-k7M9P2mguwCEwYBhgL/s640/api_retrieve.png" width="640" /></a></div><br /><br /></div><div>Capturing the traffic with Wireshark you can see that this is only storing and retrieving the key, and the ID is really not necessary at all to perform the decryption.&nbsp;</div><div><br /></div><div>As mentioned previously, the seed is being generated via an epoch time stamp. Since the objective text provides a clue that the encryption took place between a certain time, it will be possible to brute force the decryption by creating keys for that entire time range.</div><div><br /></div><div>I decided to put together a script that would loop through the time range generating keys, and then use the binary to do the heavy lifting for the decryption; however, as seen by the output, it requires an ID not a key. My initial thought process was to use the generated key, make an API call to store it, and then it would return an ID I could use as an argument to decrypt; however, I noticed that this was generating a lot of false positives as well as other issues.</div><div><br /></div><div>Crypto-wise, I knew it didn't really need the ID to decrypt, but there was that internet check. If the internet was not up, it would terminate the binary. To overcome this and speed up the decryption process, I decided to spin up a local Python-server listening on localhost, and modified my hosts file so any requests to the actual API would hit my server instead. The Python server would only just reflect whatever was sent to it, so it bypassed the internet check and proceeded to decrypt based on the key that was reflected back.<br /><br />The following is the script used for the decryption:<br /><script src="https://gist.github.com/Keramas/f044f22dff609684f363103aa2f4cd0a.js"></script><br /><br />Example Python server to respond to the API requests:<br /><script src="https://gist.github.com/Keramas/11237391457f44e2b527a2a32dc57778.js"></script><br /><br /></div><div>Running this, it takes a slight bit and there were a lot of false positive decryptions. However, setting up a monitoring script or just using the "file" command to keep an eye on things, eventually we find a valid decryption took place. Corrupted files are determined to just be "data", while our valid decryption is showing to be an actual PDF file.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-GivQrFWxtQQ/XhEwuRZnNYI/AAAAAAAABLQ/iHerFRqdyV83Mv6tc4GU2RMOcGLJ8EzBwCLcBGAsYHQ/s1600/valid_id_found.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="404" data-original-width="1181" height="218" src="https://1.bp.blogspot.com/-GivQrFWxtQQ/XhEwuRZnNYI/AAAAAAAABLQ/iHerFRqdyV83Mv6tc4GU2RMOcGLJ8EzBwCLcBGAsYHQ/s640/valid_id_found.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-LMi47ONxK0g/XhEwyDtIM5I/AAAAAAAABLU/H1awq91sEnA2strjCbj6usJzMhFMexlVgCLcBGAsYHQ/s1600/decryption_confirmed_file.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="467" data-original-width="400" height="400" src="https://1.bp.blogspot.com/-LMi47ONxK0g/XhEwyDtIM5I/AAAAAAAABLU/H1awq91sEnA2strjCbj6usJzMhFMexlVgCLcBGAsYHQ/s400/decryption_confirmed_file.png" width="342" /></a></div><br />Now we know that the file was encrypted on Friday, December 6, 2019 at 8:20:49 PM GMT.<br /><br />Opening up the decrypted PDF, we find the answer to the objective:</div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Yx17wKbahxA/XgbC8itLD_I/AAAAAAAABIk/Z0KofLvMiusLWgy7QbFj713bZZC9GKpJgCEwYBhgL/s1600/crypto_solution_pdf.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="727" data-original-width="531" height="400" src="https://1.bp.blogspot.com/-Yx17wKbahxA/XgbC8itLD_I/AAAAAAAABIk/Z0KofLvMiusLWgy7QbFj713bZZC9GKpJgCEwYBhgL/s400/crypto_solution_pdf.png" width="291" /></a></div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div>