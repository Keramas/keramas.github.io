---
layout: post
title: 'Stinging with a sharp serpent: Windows post-exploitation with SILENTTRINITY
  & IronPython'
date: '2018-10-14T04:12:00.000-07:00'
author: Keramas
tags: 
modified_time: '2018-10-14T13:36:56.874-07:00'
thumbnail: https://2.bp.blogspot.com/-UsMSJdJmr54/W8McgFBl0HI/AAAAAAAAAsY/UOh1_Gvj28YSzhIxQRKgDgSEyMV9_01TgCPcBGAYYCw/s72-c/ST-bootup.png
blogger_id: tag:blogger.com,1999:blog-4206503528938574504.post-681652971247645686
blogger_orig_url: https://k3ramas.blogspot.com/2018/10/stinging-with-sharp-serpent-windows.html
---

Powershell is beginning to lose its power for offense as the detection and mitigation of Powershell-based attacks is rising, and the focus is currently shifting to C# for tool creation as it can directly tap the .NET framework similar to Powershell.<br /><br />Derbycon 8 had a ton of amazing talks, and I am now just catching up on all of them (thanks Irongeek!) since I decided to spend nearly 100% of my time at the con immersed in the CTF. One of the talks I was really looking forward to checking out was about IronPython presented by Marcello Salvati (byt3bl33d3r) titled "<a href="https://youtu.be/NaFiAx737qg">IronPython... omfg</a>".<br /><br />Marcello developed an amazing C2/post-exploitation framework called "<a href="https://github.com/byt3bl33d3r/SILENTTRINITY">SILENTTRINITY</a>" using&nbsp;<a href="http://ironpython.net/">IronPython</a>, which is able to also utilize the .NET framework. Definitely be sure to watch the video for an in-depth explanation of how IronPython can be used as well as a nice demo of how the his tool works.<br /><br />After listening to the talk, I decided to give SILENTTRINITY a whirl.<br /><br /><b>Setup and starting the server:</b><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">git clone https://github.com/byt3bl33d3r/SILENTTRINITY.git<br />apt-get install python3.7<br />apt-get install python3.7-dev<br /><span style="background-color: #0f140f; color: #008800; font-style: italic;">#Ensure you have pip installed for python</span><br />apt-get install python3-pip<br />python3.7 -m pip install -r requirements.txt<br /><span style="background-color: #0f140f; color: #008800; font-style: italic;">#From within the /server folder:</span><br />python3.7 st.py<br /></pre></div><br /><a href="https://2.bp.blogspot.com/-UsMSJdJmr54/W8McgFBl0HI/AAAAAAAAAsY/UOh1_Gvj28YSzhIxQRKgDgSEyMV9_01TgCPcBGAYYCw/s1600/ST-bootup.png" imageanchor="1"><img border="0" data-original-height="342" data-original-width="760" height="288" src="https://2.bp.blogspot.com/-UsMSJdJmr54/W8McgFBl0HI/AAAAAAAAAsY/UOh1_Gvj28YSzhIxQRKgDgSEyMV9_01TgCPcBGAYYCw/s640/ST-bootup.png" width="640" /></a><br /><br />Once launched, it is not all too different than how you would use Empire; however, it has some really nice auto-completion that displays a drop down menu of possible commands. To get started, a listener needs to be created. <br /><br /><a href="https://3.bp.blogspot.com/-Y_nMrRC_oRc/W8McgHu0N1I/AAAAAAAAAtI/O8iLS0WMZt0MrAck1x2gkJIlHzrSvCBYQCPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B04-52-42.png" imageanchor="1"><img border="0" data-original-height="441" data-original-width="763" height="369" src="https://3.bp.blogspot.com/-Y_nMrRC_oRc/W8McgHu0N1I/AAAAAAAAAtI/O8iLS0WMZt0MrAck1x2gkJIlHzrSvCBYQCPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B04-52-42.png" width="640" /></a><br /><br />Using the http listener, the next line of business is to create a stager that can be launched on the victim machine. Using the msbuild option, an XML file will be created in the server folder.<br /><br /><a href="https://4.bp.blogspot.com/-mMmkI2Wf2XY/W8McgNShOLI/AAAAAAAAAtA/Z6CH16Y6foYXV6TUiB8dUWD6YdUJxpKMQCPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B04-53-27.png" imageanchor="1"><img border="0" data-original-height="297" data-original-width="856" height="222" src="https://4.bp.blogspot.com/-mMmkI2Wf2XY/W8McgNShOLI/AAAAAAAAAtA/Z6CH16Y6foYXV6TUiB8dUWD6YdUJxpKMQCPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B04-53-27.png" width="640" /></a><br /><br />In order to avoid dropping a file onto the victim machine, we can spin up an SMB server using Impacket, and then have the host grab and run the XML.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #111111; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">python smbserver.py SMB /root/SMB<br /></pre></div><br />On the victim machine, the stager command is executed, and we get a callback creating a session.<br /><br /><a href="https://4.bp.blogspot.com/-49z-wVe6gJU/W8McgtYGL8I/AAAAAAAAAtQ/5rvD87ZByNMWAjiWE3qi0pEPxBMFgWn8QCPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B05-14-34.png" imageanchor="1"><img border="0" data-original-height="519" data-original-width="982" height="337" src="https://4.bp.blogspot.com/-49z-wVe6gJU/W8McgtYGL8I/AAAAAAAAAtQ/5rvD87ZByNMWAjiWE3qi0pEPxBMFgWn8QCPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B05-14-34.png" width="640" /></a><br /><br /><a href="https://2.bp.blogspot.com/-UQSy-35CzM0/W8Mcgz4JkpI/AAAAAAAAAtE/tOsPv6m412EIJRGpv0usi6wAexZuaAH3wCPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B05-15-03.png" imageanchor="1"><img border="0" data-original-height="286" data-original-width="875" height="209" src="https://2.bp.blogspot.com/-UQSy-35CzM0/W8Mcgz4JkpI/AAAAAAAAAtE/tOsPv6m412EIJRGpv0usi6wAexZuaAH3wCPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B05-15-03.png" width="640" /></a><br /><br />It is now possible to interact with the victim machine by using various modules not unlike Empire.<br /><br /><a href="https://2.bp.blogspot.com/-aq0QShFe4vE/W8Mche8tA0I/AAAAAAAAAtQ/jSGAfF8z70IOkcLTUM5nXVEW5zsQb11UQCPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B05-16-14.png" imageanchor="1"><img border="0" data-original-height="459" data-original-width="1179" height="249" src="https://2.bp.blogspot.com/-aq0QShFe4vE/W8Mche8tA0I/AAAAAAAAAtQ/jSGAfF8z70IOkcLTUM5nXVEW5zsQb11UQCPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B05-16-14.png" width="640" /></a><br /><br />Utilizing the 'execute-assembly' module, it is possible to execute .NET assemblies from the attacker machine in memory on the victim machine. Ghostpack is perfect for this, and as an example I ran SharpUp. <br /><br /><a href="https://2.bp.blogspot.com/-iqiUkRbbEPc/W8McjCMNc9I/AAAAAAAAAtQ/jtENEqFW1qUPg73Yk-pzburhdURxx0vqACPcBGAYYCw/s1600/Screenshot%2Bfrom%2B2018-10-14%2B05-50-54.png" imageanchor="1"><img border="0" data-original-height="737" data-original-width="920" height="512" src="https://2.bp.blogspot.com/-iqiUkRbbEPc/W8McjCMNc9I/AAAAAAAAAtQ/jtENEqFW1qUPg73Yk-pzburhdURxx0vqACPcBGAYYCw/s640/Screenshot%2Bfrom%2B2018-10-14%2B05-50-54.png" width="640" /></a><br /><br />Running all of this, and not once did my Windows Defender raise the alarm in my Windows 10 VM! This is absolutely a game changer, and I think it may be time for me to start digging into C# as well as IronPython.<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />